# Режим bridge

Эта статья описывает особый режим работы кластера {{ ydb-short-name }}, при котором хранение данных осуществляется с синхронной репликацией между несколькими [пайлами](glossary.md#pile).

Режим bridge позволяет достичь максимальной отказоустойчивости кластера. Однако, он требует большего количества оборудования и сложнее в эксплуатации, чем другие режимы работы кластера. Режим bridge рекомендуется для кластеров, размещенных в двух дата-центрах и для кластеров с высокими требованиями к отказоустойчивости, например, если требуется сохранять доступность при отказе трёх дата-центров из четырех.

## Описание режима

В режиме bridge узлы кластера разделяют на несколько [пайлов](glossary.md#pile) (обычно дата-центров). При отказе части пайлов, кластер становится недоступным до тех пор, пока не будет выполнена команда отключения отказавшего пайла. После отключения кластер возобновляет работу.

Поддерживается произвольное количество пайлов, однако, для простоты изложения далее рассматривается случай с двумя пайлами.

Для хранения данных используются пары групп Distributed Storage из разных пайлов, при этом для хранения данных в разных пайлах возможно использование любых комбинаций поддерживаемых {{ ydb-short-name }} [режимов работы](topology.md#cluster-config).

На уровне распределённого хранилища в режиме bridge осуществляется синхронная репликация (Active / Active) между пайлами. На уровне динамических узлов может осуществляться резервирование по схеме Active / Passive.

В режиме bridge может быть достигнут zero-downtime switchover. При failover кластер требует явного отключения репликации в отказавший пайл для возобновления работы. Failover при отключении любого пайла происходит с приостановкой обслуживания до отключения репликации в отказавший пайл.

Пайлы не являются самостоятельными кластерами {{ ydb-short-name }}, а являются частью одного кластера со сложной топологией:

— таблетки в режиме bridge запускаются в единственном экземпляре;

— в каждом пайле работает самостоятельная статическая группа и набор самостоятельных групп хранения с обычными VDisk. Доступ к группам хранения осуществляется через dsproxy-proxy, предоставляющую таблеткам интерфейс dsproxy и выполняющую операции при помощи 2 dsproxy по одной для групп в каждом пайле;

— в каждом пайле работает свой набор реплик state storage, scheme board и board. Доступ к state storage и бордам осуществляется через аналогичные proxy-proxy.

## Состояния пайлов

Режим работы кластера определяется состояниями всех его пайлов. Так, для кластера из пайлов А и Б мы будем указывать состояния работы соответственно пайлов А и Б (порядок важен).

Пайлы могут находиться в одном из следующих состояний:

- PRIMARY. Основной пайл, в котором работают таблетки. В этом состоянии пайл может быть переключен в состояния SYNCHRONIZED, DISCONNECTED, DEMOTED, SUSPENDED. Только один пайл может находиться в состоянии PRIMARY.

- SYNCHRONIZED. Ведомый пайл, в котором все группы хранения синхронизированы с PRIMARY. Пайл из этого состояния может быть переключен в состояния PRIMARY, PROMOTED, SUSPENDED, DISCONNECTED, DEMOTED.

- DISCONNECTED. Отключенный от PRIMARY, не участвует в выполнении операций. Из этого состояния пайл может быть переключен только в состояние NOT_SYNCHRONIZED.

- NOT_SYNCHRONIZED. Пайл, в котором группы хранения еще не синхронизированы с PRIMARY. При завершении синхронизации {{ ydb-short-name }} автоматически переключает пайл в состояние SYNCHRONIZED. В состоянии NOT_SYNCHRONIZED пайл может быть переключен в состояния SUSPENDED, DISCONNECTED.

- PROMOTED. Пайл, который необходимо плавно переключить из состояния SYNCHRONIZED в состояние PRIMARY. Пайл пребывает в этом состоянии до завершения плавного переключения, после чего {{ ydb-short-name }} автоматически переключает пайл в состояние PRIMARY. В состоянии PROMOTED пайл может быть переключен в состояния PRIMARY, SYNCHRONIZED, DISCONNECTED, DEMOTED, SUSPENDED.

- DEMOTED. Пайл, который необходимо плавно переключить из состояния PRIMARY в состояние SYNCHRONIZED. Пайл пребывает в этом состоянии до завершения плавного переключения, после чего {{ ydb-short-name }} автоматически переключает пайл в состояние SYNCHRONIZED. В состоянии DEMOTED пайл может быть переключен в состояния PRIMARY, SYNCHRONIZED, DISCONNECTED, PROMOTED, SUSPENDED.

- SUSPENDED. Пайл, который необходимо плавно переключить в состояние DISCONNECTED. По завершении переключения {{ ydb-short-name }} автоматически переключает пайл в состояние DISCONNECTED. В состоянии SUSPENDED пайл может быть переключен в состояния DISCONNECTED, NOT_SYNCHRONIZED.

В норме пара пайлов работает в режиме PRIMARY/SYNCHRONIZED или SYNCHRONIZED/PRIMARY. То есть один из пайлов - PRIMARY, в нем работают таблетки, второй пайл - SYNCHRONIZED, все его группы хранения синхронизированы c PRIMARY. Операция записи считается завершенной при таком состоянии пайлов только после успешного выполнения записи в группы хранения каждого пайла с необходимой избыточностью.


## Сценарии изменения состояния

### Отказ пайла {#failover}

При отказе пайла, кластер становится недоступным. Для возобновления работы кластера необходимо отключить отказавший пайл, переведя его в состояние DISCONNECTED.

Администратор может подать команду переключения из PRIMARY/SYNCHRONIZED или SYNCHRONIZED/PRIMARY в любой из режимов PRIMARY/DISCONNECTED или DISCONNECTED/PRIMARY. Команда меняет конфигурацию групп хранения и приводит к изменению способа записи в группы хранения. Интерконнект разрывает сессии со всеми узлами DISCONNECTED пайла, и не устанавливает сессии для обмена данными (TCP соединения для обмена метаданными о состояниях пайлов при этом могут быть установлены). Дальнейшая запись и чтение выполняются без участия DISCONNECTED пайла. Если поменялся PRIMARY пайл, таблетки перезапускаются в нем.

Аналогично выполняется переключение и в случае, когда отказавший пайл был в любом другом состоянии, а назначаемый PRIMARY пайл был в одном из допустимых состояний (PRIMARY, SYNCHRONIZED, PROMOTED, DEMOTED).

Если назначаемый PRIMARY пайл был в состоянии DISCONNECTED, NOT_SYNCHRONIZED или SUSPENDED, то штатное переключение невозможно, так как пайл может не содержать полноценной реплики данных.

### Восстановление пайла {#rejoin}

После восстановления работоспособности узлов отказавшего пайла, необходимо снова подключить этот пайл к кластеру, переведя его в состояние NOT_SYNCHRONIZED.

Администратор может подать команду переключения из PRIMARY/DISCONNECTED в PRIMARY/NOT_SYNCHRONIZED или из DISCONNECTED/PRIMARY в NOT_SYNCHRONIZED/PRIMARY. Произойдет обмен конфигурацией между узлами, сессии interconnect устанавливаются только между узлами, имеющими одинаковую конфигурацию. Команда запускает синхронизацию групп хранения. В результате синхронизации групп хранения произойдет автоматическое переключение из PRIMARY/NOT_SYNCHRONIZED в PRIMARY/SYNCHRONIZED или из NOT_SYNCHRONIZED/PRIMARY в SYNCHRONIZED/PRIMARY.

### Плановое переключение PRIMARY пайла {#switchover}

Для плановой смены PRIMARY пайла необходимо перевести его в состояние DEMOTED, а назначаемый PRIMARY пайл в состояние PROMOTED.

Администратор может подать команду переключения из PRIMARY/SYNCHRONIZED в DEMOTED/PROMOTED или наоборот из SYNCHRONIZED/PRIMARY в PROMOTED/DEMOTED. Команда не приводит к изменениям в способе записи в группы хранения, однако меняет конфигурацию групп хранения и приводит к смене PRIMARY пайла и плавному переезду в него таблеток. По завершении переключения PROMOTED переходит в PRIMARY, DEMOTED переходит в SYNCHRONIZED.

### Плановое отключение пайла {#takedown}

Для планового отключения пайла необходимо перевести его в состояние SUSPENDED.

Администратор может подать команду переключения из PRIMARY/SYNCHRONIZED в PRIMARY/SUSPENDED или из SYNCHRONIZED/PRIMARY в SUSPENDED/PRIMARY. Будет произведен плановый вывод узлов переключенного в SUSPENDED пайла в режим DISCONNECTED. Система при этом стремится минимизировать влияние переключения на работу кластера. После завершения переключения пайла в режим DISCONNECTED, узлы этого пайла могут быть выключены для обслуживания.

### Восстановление при разделении кластера на две части с несовместимой конфигурацией (split brain) {#split-brain}

Возможна ситуация, когда администратор привел кластер в состояние, в котором пайлы А и Б были изолированы друг от друга и пайл А был переконфигурирован в состояние, в котором А - PRIMARY, а Б - SYNCHRONIZED, а пайл Б переконфигурирован в состояние, в котором Б - PRIMARY, а А - SYNCHRONIZED, то есть произошло разделение кластера на две части с несовместимой конфигурацией (split brain). В таком состоянии каждая половина кластера может сохранять работоспособность.

Для восстановления единого кластера необходимо выбрать, какой из пайлов будет очищен, после чего остановить все узлы очищаемого пайла, дождавшись их остановки, очистить все диски всех узлов, после чего снова включить узлы очищаемого пайла.

После этого необходимо выполнить штатное восстановление пайла, переключив его в состояние NOT_SYNCHRONIZED.

### Нештатное восстановление пайла

В сложных ситуациях, например, при стремительных последовательных отказах пайлов, может возникнуть ситуация, когда сначала отказал пайл А, он был переключен в состояние DISCONNECTED и кластер продолжил работу, затем в результате отказа был безвозвратно утрачен пайл Б, а через некоторое время удалось восстановить работоспособность пайла А. В таких ситуациях может быть предпринята попытка восстановления кластера на базе пайла А.

При необходимости возобновления работы кластера в ситуации, когда работоспособность сохранил только находящийся в состоянии DISCONNECTED, NOT_SYNCHRONIZED или SUSPENDED пайл, администратор может подать команду переключения из PRIMARY/DISCONNECTED в DISCONNECTED/PRIMARY (или аналогично для NOT_SYNCHRONIZED или SUSPENDED) с указанием специального параметра `force`. Произойдет разделение кластера на две части с несовместимой конфигурацией. В зависимости от фактического состояния данных в переключаемом в PRIMARY состояние пайле, кластер может быть восстановлен в корректное, либо во внутренне неконсистентное состояние. Успешная эксплуатация такого кластера не гарантируется.

Если полученный кластер оказался работоспособным, то далее возможно восстановление кластера в нормальное состояние, для чего необходимо перед выполнением восстановления отключенного пайла выполнить полную очистку данных и метаданных на всех его узлах, после чего перевести пайл в состояние NOT_SYNCHRONIZED.

## Особенности реализации режима bridge

Подробности реализации доступны в разделе для разработчиков: [Устройство режима bridge](../contributor/bridge.md).
