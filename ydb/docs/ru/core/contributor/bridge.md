# Устройство режима bridge

Общее описание режима и сценарии использования см. в статье [Режим bridge](../concepts/bridge.md). Эта статья сфокусирована на технических деталях реализации и предназначена для разработчиков и контрибьюторов {{ ydb-short-name }}.

## Хранение конфигураций

Distconf хранит конфигурацию двух статических групп, двух наборов state storage, scheme board и board. Там же хранится и режим работы кластера.

Для хранения конфигурации статических групп, state storage и бордов используется схема хранения с двумя комплектами кворумов:

  - кворум 1+А, использующий только узлы в пайле А. Запись успешна при успешной записи на кворуме узлов в пайле А и на кворуме статической группы 1.

  - кворум 2+Б, использующий только узлы в пайле Б. Запись успешна при успешной записи на кворуме узлов в пайле Б и на кворуме статической группы 2.

При отказе одного из пайлов запись в соответствующий кворум невозможна.

Distconf хранит конфигурацию и использует при этом кворумы 1+А и 2+Б:

  - Конфигурация, содержащая режим PRIMARY/DISCONNECTED записывается только в кворум 1+А.

  - Конфигурация, содержащая режим DISCONNECTED/PRIMARY записывается только в кворум 2+Б.

  - Все остальные режимы записываются и в кворум 1+А и в кворум 2+Б.

При failover администратор подает команду переключения в режим PRIMARY/DISCONNECTED или DISCONNECTED/PRIMARY, в этом режиме конфигурация общих компонент сохраняется только на кворуме из PRIMARY пайла.

Для начала восстановления администратор подает команду переключения пары из живого и отказавшего пайла в режим PRIMARY/NOT_SYNCHRONIZED, эта конфигурация сохраняется на всех кворумах.

Сохранение конфигурации не должно происходить при несовместимости сохраняемой и последней сохраненной конфигурации на узле, например недопустим переход из PRIMARY/DISCONNECTED в DISCONNECTED/PRIMARY. Это необходимо для выявления переключения пайла А в режим PRIMARY/DISCONNECTED и одновременного переключения пайла Б в режим DISCONNECTED/PRIMARY.

Для защиты от взаимодействия пайла А и пайла Б в случае перехода в такой режим предлагается предусмотреть разрыв/отказ устанавливать сессии интерконнекта при такого рода конфликте конфигураций нод.

## Запуск статических групп

Так как конфигурация каждой из статических групп хранится только в соответствующем пайле, статические группы получают конфигурацию от дистконфа, собравшего кворум в соответствующем пайле.

Получившие конфигурацию Node Warden запускают VDisk и PDisk статической группы.

Для доступа к статической группе предлагается использовать dsproxy-proxy, сервис, предоставляющий таблеткам интерфейс dsproxy и выполняющий операции синхронно с двумя группами в паре.

Dsproxy-proxy статической группы меняет режим работы в зависимости от конфигурации полученной от distconf. Конфигурация Dsproxy-proxy хранится в конфигурации общих компонент.

## Поведение dsproxy-proxy

в режиме PRIMARY/SYNCHRONIZED запись выполняется синхронно в 2 группы, чтение выполняется из PRIMARY и на каждом чтении выполняется пинг-запрос во вторую группу чтобы гарантировать своевременное уведомление о разрыве связи/смене режима работы группы.

в режиме PRIMARY/DISCONNECTED запись и чтение выполняется только в PRIMARY группе.

в режиме PRIMARY/NOT_SYNCHRONIZED dsproxy-proxy имеет множество подрежимов работы, определяющих, какие виды записи выполняются в SECONDARY группе:

  WRITE_KEEP - выполняется только запись KEEP флагов

  WRITE_KEEP_BARRIER_DONOTKEEP - выполняется запись барьеров, KEEP, DO NOT KEEP флагов

  WRITE_KEEP_BARRIER_DONOTKEEP_DATA - выполняется запись данных, барьеров, KEEP, DO NOT KEEP флагов

Конфигурация dsproxy-proxy содержит:

  - режим

  - подрежим

  - PPGeneration - номер поколения конфигурации dsproxy-proxy

  - номер поколения конфигурации dsproxy группы из пайла А

  - номер поколения конфигурации dsproxy группы из пайла Б

При смене конфигурации dsproxy-proxy обязательно изменение номера поколения конфигурации и конфигурации группы для PRIMARY группы - всегда, для SECONDARY - кроме как в состоянии DISCONNECTED.

В конфигурацию группы вводится:

  - режим

  - подрежим

  - PPGeneration - номер поколения конфигурации управляющей dsproxy-proxy

При каждой операции группы проверяют режим, подрежим и PPGeneration. Это необходимо чтобы не выполнялись операции от старых dsproxy-proxy, пропустивших смену режима или подрежима и не произошло перекрестное взаимодействие при возникновении двух PRIMARY.

Для продвижения из режима PRIMARY/NOT_SYNCHRONIZED в режим PRIMARY/SYNCHRONIZED выполняется синхронизация. В процессе синхронизации происходит перенос недостающих данных из PRIMARY группы в SECONDARY группу и двустороннее копирование информации о блокировках.

## Bootstrap BSController и других системных таблеток

В списке узлов для запуска таблетки достаточно перечислить один набор узлов включающий достаточно количество узлов из каждого пайла. Bootstrapper должен смотреть на конфигурацию state storage proxy-proxy и по ней определять, можно ли запускать на ноде таблетку. Если таблетку на ноде запускать нельзя (т.к. нода не в PRIMARY пайле), Bootstrapper должен пройти по дереву подсоединившихся к нему Bootstrapper-ов и назначить запускателем таблетки Bootstrapper из PRIMARY пайла. Если такого нет, таблетку запускать этому Bootstrapper нельзя.

## Конфигурация и запуск остальных таблеток

Динамическими группами хранения управляет BS Controller. Вместо каждого обычного storage-пула каждый раз создается 3 storage-пула, в пуле А - группы из пайла А, в пуле Б - группы из пайла Б, в пуле Ц - прокси-прокси группы, составленные из пар групп из пулов А и Б. Управляемые хайвом таблетки используют только группы прокси-прокси из пула Ц.

Запуск таблеток выполняется только в PRIMARY или PROMOTED пайла. Перевоз таблеток из DEMOTED в PROMOTED выполняется по возможности мягко, перевоз таблеток из DISCONNECTED в PRIMARY происходит как можно быстрее.

## Поведение interconnect

В интерконнекте разделяется обмен метаданными и установка сессии.

Обмен метаданными происходит до установления сессии и позволяет паре узлов определить используемый набор фич интерконнекта и обменяться конфигурацией.

 интерконнект с узлами из disconnected половины кластера разрывается и попыток установления соединения не предпринимается. Установление соединения возможно только после перевода пайлов в состояние PRIMARY/NOT_SYNCHRONIZED.
 