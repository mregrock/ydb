# Устройство режима bridge  

Общее описание режима и сценарии использования см. в статье [{#T}](../concepts/bridge.md). Эта статья предназначена для разработчиков и контрибьюторов {{ ydb-short-name }} и содержит технические детали реализации режима bridge.  

## Хранение конфигураций  

[Distconf](../concepts/glossary.md#distributed-configuration) хранит конфигурацию двух статических групп, двух наборов state storage, а также scheme board и board. В нём же сохраняется режим работы кластера.  

Конфигурация статических групп, state storage и бордов использует схему хранения с двумя комплектами кворумов:  

  - Кворум 1+А — включает только узлы из пайла А. Запись считается успешной, если она прошла на кворуме узлов пайла А и на кворуме статической группы 1.  
  - Кворум 2+Б — включает только узлы из пайла Б. Запись считается успешной, если она прошла на кворуме узлов пайла Б и на кворуме статической группы 2.  

При отказе одного из пайлов запись в соответствующий кворум становится невозможной.  

Distconf использует оба кворума (1+А и 2+Б) для хранения конфигурации:  

  - Конфигурация с режимом `PRIMARY/DISCONNECTED` записывается только в кворум 1+А;  
  - Конфигурация с режимом `DISCONNECTED/PRIMARY` записывается только в кворум 2+Б;  
  - Все остальные режимы записываются в оба кворума — 1+А и 2+Б.  

При выполнении failover администратор переводит кластер в режим `PRIMARY/DISCONNECTED` или `DISCONNECTED/PRIMARY`. В этом режиме конфигурация общих компонентов сохраняется только на кворуме из PRIMARY-пайла.  

Для начала восстановления администратор переводит пару из живого и отказавшего пайлов в режим `PRIMARY/NOT_SYNCHRONIZED`. Такая конфигурация сохраняется на всех кворумах.  

Запись конфигурации запрещена, если новая конфигурация несовместима с последней сохранённой на узле. Например, переход из `PRIMARY/DISCONNECTED` в `DISCONNECTED/PRIMARY` недопустим. Это предотвращает ситуацию, при которой пайлы А и Б одновременно переключаются в режимы, претендующие на роль `PRIMARY`.  

Для защиты от взаимодействия пайла А и пайла Б в случае конфликта конфигураций блокируется установка сессий interconnect при обнаружении подобных несоответствий на узлах.  

## Запуск статических групп  

Поскольку конфигурация каждой статической группы хранится только в соответствующем пайле, статические группы получают её от Distconf, собравшего кворум в этом пайле.  

Получив конфигурацию, Node Warden запускает VDisk и PDisk соответствующей статической группы.  

Для доступа к статической группе используется сервис `dsproxy-proxy`, который предоставляет таблеткам интерфейс `dsproxy` и выполняет операции синхронно с обеими группами в паре.  


Dsproxy-proxy статической группы меняет режим работы в зависимости от конфигурации, полученной от distconf. Конфигурация dsproxy-proxy хранится в конфигурации общих компонент.

## Поведение dsproxy-proxy {#dsproxy-proxy}

В режиме `PRIMARY/SYNCHRONIZED` запись выполняется синхронно в две группы; чтение выполняется из `PRIMARY`, и при каждом чтении выполняется ping-запрос во вторую группу, чтобы гарантировать своевременное уведомление о разрыве связи или смене режима работы группы.

В режиме `PRIMARY/DISCONNECTED` запись и чтение выполняются только в `PRIMARY`-группе.

В режиме `PRIMARY/NOT_SYNCHRONIZED` dsproxy-proxy поддерживает несколько подрежимов, определяющих, какие виды записи выполняются во `SECONDARY`-группе:

  - `WRITE_KEEP` — выполняется только запись KEEP-флагов;
  - `WRITE_KEEP_BARRIER_DONOTKEEP` — выполняется запись барьеров, KEEP- и DO NOT KEEP-флагов;
  - `WRITE_KEEP_BARRIER_DONOTKEEP_DATA` — выполняется запись данных, барьеров, KEEP- и DO NOT KEEP-флагов.

Конфигурация dsproxy-proxy содержит:

  - режим;
  - подрежим;
  - `PPGeneration` — номер поколения конфигурации dsproxy-proxy;
  - номер поколения конфигурации dsproxy-группы из пайла А;
  - номер поколения конфигурации dsproxy-группы из пайла Б.

При изменении конфигурации dsproxy-proxy обязательно изменяется номер поколения конфигурации и конфигурации группы для `PRIMARY`-группы — всегда, для `SECONDARY` — за исключением состояния `DISCONNECTED`.

В конфигурацию группы включаются:

  - режим;
  - подрежим;
  - `PPGeneration` — номер поколения конфигурации управляющего dsproxy-proxy.

При каждой операции группа проверяет режим, подрежим и `PPGeneration`. Это необходимо, чтобы не выполнялись операции от устаревших экземпляров dsproxy-proxy, пропустивших смену режима или подрежима, и чтобы избежать перекрёстного взаимодействия при возникновении двух `PRIMARY`.

Для перехода из режима `PRIMARY/NOT_SYNCHRONIZED` в режим `PRIMARY/SYNCHRONIZED` выполняется синхронизация. В ходе синхронизации недостающие данные переносятся из `PRIMARY`-группы в `SECONDARY`-группу, а также выполняется двустороннее копирование информации о блокировках.

## Bootstrap BSController и других системных таблеток {#bootstrap}

В списке узлов для запуска таблетки достаточно указать один набор узлов, включающий достаточное количество узлов из каждого пайла. Bootstrapper должен анализировать конфигурацию state storage proxy-proxy и на её основе определять, можно ли запускать таблетку на данном узле. Если запуск таблетки на узле невозможен (поскольку узел не находится в `PRIMARY`-пайле), Bootstrapper должен пройти по дереву подключённых к нему Bootstrapper-ов и назначить в качестве запускающего Bootstrapper из `PRIMARY`-пайла. Если такого Bootstrapper-а нет, текущий Bootstrapper не должен запускать таблетку.

## Конфигурация и запуск остальных таблеток {#other-tablets}

Динамическими группами хранения управляет BS Controller. Вместо каждого обычного storage-пула каждый раз создаётся три storage-пула: в пуле А — группы из пайла А, в пуле Б — группы из пайла Б, в пуле Ц — прокси-прокси группы, составленные из пар групп из пулов А и Б. Управляемые хайвом таблетки используют только прокси-прокси группы из пула Ц.

Запуск таблеток выполняется только в `PRIMARY` или `PROMOTED`-пайле. Перевоз таблеток из `DEMOTED` в `PROMOTED` выполняется по возможности мягко, перевоз таблеток из `DISCONNECTED` в `PRIMARY` происходит максимально быстро.

## Поведение interconnect {#interconnect}

В interconnect разделяются обмен метаданными и установка сессии.
Обмен метаданными происходит до установления сессии и позволяет паре узлов определить используемый набор функций interconnect и обменяться конфигурацией.
Interconnect с узлами из отключённой половины кластера разрывается, и попытки установления соединения не предпринимаются. Установление соединения возможно только после перевода пайлов в состояние `PRIMARY/NOT_SYNCHRONIZED`.
