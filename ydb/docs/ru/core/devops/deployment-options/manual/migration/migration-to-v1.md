# Миграция на ручную конфигурацию State Storage и статической группы

Данный документ содержит инструкцию по миграции с [конфигурации v2](../before-v25.1/configuration-management/config-overview.md) на [конфигурацию v1](../../../configuration-management/index.md).

Миграция на конфигурацию v1 происходит в 2 этапа: переход на ручное управление управление [статической группой](../../../../concepts/glossary.md#state-storage) и [State Storage](../../../../concepts/glossary.md#static-group), а затем переход на работу со [статической и динамической](../before-v25.1/index.md) конфигурациями.

{% note info %}

Данная инструкция предназначена для аварийных ситуаций, когда после перехода на автоматическую конфигурацию возникли непредвиденные проблемы и требуется откат на ручное управление. В штатном режиме работы эта процедура не требуется.

О подобных проблемах рекомендуется незамедлительно сообщать {% if audience != "corp" %}в виде [GitHub issue](https://github.com/ydb-platform/ydb/issues/new){% else %}в техническую поддержку {{ ydb-full-name }}{% endif %}, предоставляя максимум контекста и диагностики для воспроизведения.

{% endnote %}

## Исходное состояние

Миграция на конфигурацию v1 может быть осуществлена в том случае, если в кластере используется [конфигурация v2](../../../configuration-management/index.md). Это может быть достигнуто:

- либо в результате [миграции на конфигурацию v2](migration-to-v2.md)
- либо при [первоначальном развёртывании](../initial-deployment.md) кластера

Для того, чтобы убедиться в отсутствии единого конфигурационного файла на кластере {{ ydb-short-name }}, можно воспользоваться [мониторингом](../../../observability/monitoring.md). Выбрав подгруппу сенсоров `config` и подсистему `configs_dispatcher`, необходимо взглянуть на сенсоры `ConfigurationV1` и `ConfigurationV2`. На графике отобразится число узлов, работающих в режиме конфигурации v1 и v2 соответственно.

Также посмотреть версию конфигурации на отдельных узлах кластера можно с помощью веб-интерфейса актора `configs_dispatcher`, перейдя по ссылке подобного вида:

```text
http://<node.ydb.tech>:8765/actors/configs_dispatcher
```

Вы увидите страницу, в верхней части которой указана версия конфигурации `Configuration version`:

![configs-dispatcher-page](./_assets/viewer-v2.png)

В верхней части страницы указана версия конфигурации - `Configuration version`. Проверьте версию конфигурации для каждого из узлов, подключенных к кластеру.

Переключить узел на другой можно воспользовавшись поисковой строкой в правом верхнем углу страницы.

## Переход на ручное управление статической группой и State Storage

Для выключения автоматической конфигурации статической группы и State Storage выполните следующие действия:

1. Получить текущую конфигурацию кластера с помощью команды:

```bash
ydb -e grpc://<node.ydb.tech>:2135 admin storage fetch --full > config.yaml
```

Аргумент `--full` указывает, что будет получена полная конфигурация кластера, включая параметры настройки [State Storage](../../../../reference/configuration/index.md#domains-state) и [статической группы](../../../../reference/configuration/index.md#blob_storage_config).

2. Изменить конфигурационный файл `config.yaml`, поменяв значение параметра `self_management_config.enabled` с `true` на `false`:

```yaml
self_management_config:
  enabled: false
```

3. Выполнить следующую команду с изменённым конфигурационным файлом:

```bash
ydb -e grpc://<node.ydb.tech>:2135 admin storage replace -f config.yaml
```

4. Перезапустить все узлы кластера с помощью процедуры [rolling-restart](../../../../maintenance/manual/node_restarting.md).

В результате проделанных действий кластер будет переведён в режим ручного управления State Storage и статической группой.

## Переход на работу со статической и динамической конфигурацией

Для перехода на режим работы конфигурации v1, со статической и динамической конфигурацией, необходимо проделать следующие действия:

1. Получить текущую конфигурацию кластера с помощью команды:

    ```bash
    ydb -e grpc://<node.ydb.tech>:2135 admin storage fetch > config.yaml
    ```

1. Разместить полученный файл на все узлы кластера, например, по пути `/opt/ydb/config/config.yaml`.

1. Перезапустить узлы кластера с помощью процедуры [rolling-restart](../../../../maintenance/manual/node_restarting.md), добавив опцию `ydbd --yaml-config` при запуске узла с указанием пути до конфигурационного файла, а также убрав опцию `ydbd --config-dir`.

{% list tabs group=manual-systemd %}

- Вручную

  При ручном запуске добавьте опцию `--config.yaml`, к команде `ydbd server`, не указывая опцию `--yaml-config`:

  ```bash
  ydbd server --yaml-config /opt/ydb/config/config.yaml
  ```

- С использованием systemd

  При использовании systemd добавьте опцию `--yaml-config` к команде `ydbd server` в конфигурационный файл systemd, а также избавьтесь от опции `--config-dir`:

  ```ini
  ExecStart=/opt/ydb/bin/ydbd server --yaml-config /opt/ydb/config/config.yaml
  ```

  После обновления файла systemd выполните следующую команду, чтобы применить изменения:

  ```bash
  sudo systemctl daemon-reload
  ```

{% endlist %}

Убедиться в правильности проделанных действий можно взглянув на страницу `configs_dispatcher` во вьювере:

```text
http://<node.ydb.tech>:8765/actors/configs_dispatcher
```

На каждом из узлов кластера `Configuration version` должен равняться v1.

В результате проделанных действий кластер будет переведён в режим в конфигурации v1. Динамическая конфигурация все также управляется через команды {{ ydb-short-name }} CLI, однако статическая, после обновления, размещается на узлы кластера вручную.