# Миграция на автоматическую конфигурацию State Storage и статической группы

Данный документ содержит инструкции по миграции на [автоматическую конфигурацию](../../../configuration-management/index.md) [State Storage](../../../../concepts/glossary.md#state-storage) и [статической группы](../../../../concepts/glossary.md#static-group) кластера {{ ydb-short-name }}. Эти компоненты являются ключевыми для корректной работы кластера, но их ручная конфигурация не тривиальна. Таким образом, возможность автоматической конфигурации этих компонентов позволяет:

- снизить риск человеческих ошибок при конфигурировании;
- упростить управление статической группой и State Storage кластера, а также обслуживание серверов, на которых они располагаются;
- обеспечить более надёжную работу кластера.

{% note important %}

Автоматическая конфигурация State Storage и статической группы  является предпочтительным способом для кластеров версии v25.1 и выше. В дальнейшем ручной способ их конфигурации  будет считаться устаревшим, потому следует мигрировать на автоматическую их конфигурацию при первой возможности.

{% endnote %}

## Исходное состояние

Миграция на автоматическую конфигурацию может быть осуществлена в случае выполнения всех следующих условий:

1. Кластер {{ydb-short-name}} [обновлён](../../../maintenance/upgrade.md) до версии v25.1 и выше.
2. Кластер {{ydb-short-name}} перешёл на [конфигурацию v2](../../../configuration-management/index.md). Либо посредством миграции согласно [{#T}](migration-to-v2.md), либо изначально был с ней [развёрнут](../initial-deployment.md).
3. И статическая группа и State Storage сконфигурированы вручную. Эти компоненты связаны, так что конфигурирование одного из них автоматически, а второго вручную не поддерживается.

## Процедура миграции

Для включения автоматической конфигурации кластера, необходимо проделать следующие шаги:

1. Получить текущую конфигурацию кластера:

  ```bash
  ydb -e grpc://<node.ydb.tech>:2135 admin cluster config fetch > config.yaml
  ```

  Файл `config.yaml` должен совпадать с конфигурационными файлами, разложенными по нодам кластера, за исключением поля `metadata.version`, которое должно быть больше на единицу по сравнению с версией на узлах кластера.

2. Добавить в `config.yaml` в разделе `config` следующий блок:

  ```yaml
  self_management_config:
    enabled: true
  ```

3. Разложить обновленный конфигурационный файл `config.yaml` по всем нодам кластера по пути, указанном в аргументе `ydbd --yaml-config`.
4. Перезапустить все [узлы хранения](../../../../concepts/glossary.md#storage-node) кластера с помощью процедуры [rolling restart](../../../../reference/ydbops/rolling-restart-scenario).
5. При наличии секции `config.domains_config.security_config` в файле `config.yaml`, вынести её на уровень выше, в секцию `config`.
6. Удалить из файла `config.yaml` секции `config.blob_storage_config` и `config.domains_config`.
7. Выполнить следующую команду с изменённым конфигурационным файлом:

```bash
ydb -e grpc://<node.ydb.tech>:2135 cluster config replace -f config.yaml
```

В результате проделанных действий кластер будет переведён в режим автоматического управление конфигурацией [State Storage](../../../../reference/configuration/index.md#domains-state) и [статической группой](../../../../reference/configuration/index.md#blob_storage_config). Технически, оно осуществляется с помощью механизма [распределённой конфигурации](../../../../concepts/glossary.md#distributed-configuration). Взаимодействие с конфигурацией осуществляется все так же в рамках конфигурации v2, используя [команды YDB CLI](../update-config.md).