# Миграция на конфигурацию v2

Данный документ содержит инструкцию по миграции с [конфигурации v1](../before-v25.1/configuration-management/config-overview.md) на [конфигурацию v2](../../../configuration-management/index.md).

Миграция на конфигурацию v2 происходит в 2 этапа: переход на управление конфигурацией кластера {{ ydb-short-name }} через YDB CLI, а затем переход на автоматическое управление [статической группой](../../../../concepts/glossary.md#state-storage) и [State Storage](../../../../concepts/glossary.md#static-group).

## Исходное состояние

Миграция на конфигурацию v2 может быть осуществлена в случае выполнения следующих условий:

1. Кластер {{ydb-short-name}} [обновлен](../../../maintenance/upgrade.md) до версии 25.1 и выше.
1. Кластер {{ydb-short-name}} сконфигурирован с файлом [конфигурации v1](../before-v25.1/configuration-management/config-overview.md#static-config) `config.yaml`, расположенным на файловой системе узлов и подключенным через аргумент `ydbd --yaml-config`.
1. И статическая группа и State Storage сконфигурированы вручную. Эти компоненты связаны, так что конфигурирование одного из них автоматически, а второго вручную не поддерживается.

## Переход на управление конфигурацией через CLI {#migration-to-cli}

Данный способ управления конфигурацией имеет следующие преимущества:

- валидация конфигурации на уровне запроса в CLI;
- управление конфигурацией [узлов хранения](../../../../concepts/glossary.md#storage-node) и узлов [базы данных](../../../../concepts/glossary.md#database-node) с помощью единого [набора команд](../update-config.md).

Убедиться, что на кластере отсутствует управление конфигурацией через CLI, можно проверив аргументы запуска узлов кластера:

```bash
ps aux | grep ydbd
```

Если на кластере присутствует управление конфигурацией через CLI, то в выводе команды будет присутствовать опция `ydbd --config-dir`.

Продолжать двигаться по данной инструкции необходимо только в случае отсутствия опции `ydbd --config-dir` в выводе команды.

Для того чтобы перевести кластер {{ ydb-short-name }} на управление конфигурацией через CLI, необходимо проделать следующие шаги:

1. Проверить наличие файла [динамической конфигурации](../before-v25.1/configuration-management/config-overview.md#dynamic-config) на кластере. Для этого необходимо выполнить команду:

    ```bash
    ydb -e grpc://<node.ydb.tech>:2135 admin cluster config fetch > config.yaml
    ```

    В случае отсутствия такой конфигурации на кластере, команда выдаст сообщение:

    ```bash
    YAML config is absent on this cluster.
    ```

1. (В случае отсутствия файла динамической конфигурации на кластере) Выполнить команду генерации файла динамической конфигурации. Файл будет сгенерирован на основе файла статической конфигурации, лежащего на узлах кластера:

    ```bash
    ydb -e grpc://<node.ydb.tech>:2135 admin cluster config generate > config.yaml
    ```

1. Скопировать полученный файл `config.yaml` на все узлы кластера, заместив им предыдущий файл конфигурации.
1. Создать директорию для работы кластера с конфигурацией на каждом из узлов. В случае поднятия нескольких узлов на одной машине, используйте одну и ту же директорию. Инициализируйте директорию, выполнив команду на каждом из узлов:

    ```bash
    mkdir -p /opt/ydb/config-dir
    ydb admin cluster config init --config-dir /opt/ydb/config-dir --from-file /opt/ydb/cfg/config.yaml
    ```

    В дальнейшнем система самостоятельно будет сохранять конфигурацию в указанную директорию.

4. Перезапустить все узлы кластера с помощью процедуры [rolling-restart](../../../../maintenance/manual/node_restarting.md), добавив опцию `ydbd --config-dir` при запуске узла с указанием пути до директории.

1. Выполнить следующую команду с конфигурационным файлом:

    ```bash
    ydb -e grpc://<node.ydb.tech>:2135 cluster config replace -f config.yaml
    ```

    Команда запросит подтверждение на выполнение операции, в ответ на запрос необходимо ввести `y`.

    После выполнения команды, конфигурационный файл будет загружен на кластер и сохранён на всех узлах в директории, указанной в опции `ydbd --config-dir`.


В результате проделанных действий конфигурация кластера будет переведена на управление через YDB CLI. Любое изменение конфигурации на существующих узлах выполняется с помощью специальных [команд](../update-config.md). При запуске узла актульная конфигурация будет загружена из директории, указанной в опции `ydbd --config-dir`.

## Переход на автоматическую конфигурацию State Storage и статической группы {migration-to-autoconfiguration}

Компоненты [State Storage](../../../../concepts/glossary.md#state-storage) и [статической группы](../../../../concepts/glossary.md#static-group) кластера {{ ydb-short-name }} являются ключевыми для корректной работы кластера, но их ручная конфигурация не тривиальна. Таким образом, возможность [автоматической конфигурации](../../../configuration-management/index.md) этих компонентов позволяет:

- снизить риск человеческих ошибок при конфигурировании;
- упростить управление статической группой и State Storage кластера, а также обслуживание серверов, на которых они располагаются;
- обеспечить более надёжную работу кластера.

{% note important %}

Автоматическая конфигурация State Storage и статической группы  является предпочтительным способом для кластеров версии v25.1 и выше. В дальнейшем ручной способ их конфигурации  будет считаться устаревшим, потому следует перейти на автоматическую их конфигурацию при первой возможности.

{% endnote %}

### Процедура перехода на автоматическую конфигурацию

Для включения автоматической конфигурации кластера, необходимо проделать следующие шаги:

1. Получить текущую конфигурацию кластера:

  ```bash
  ydb -e grpc://<node.ydb.tech>:2135 admin cluster config fetch > config.yaml
  ```

  Файл `config.yaml` должен совпадать с конфигурационными файлами, разложенными по нодам кластера, за исключением поля `metadata.version`, которое должно быть больше на единицу по сравнению с версией на узлах кластера.

2. Добавить в `config.yaml` в разделе `config` следующий блок:

  ```yaml
  self_management_config:
    enabled: true
  ```

3. Разложить обновленный конфигурационный файл `config.yaml` по всем нодам кластера по пути, указанном в аргументе `ydbd --yaml-config`.
4. Перезапустить все [узлы хранения](../../../../concepts/glossary.md#storage-node) кластера с помощью процедуры [rolling restart](../../../../reference/ydbops/rolling-restart-scenario).
5. При наличии секции `config.domains_config.security_config` в файле `config.yaml`, вынести её на уровень выше, в секцию `config`.
6. Удалить из файла `config.yaml` секции `config.blob_storage_config` и `config.domains_config`.
7. Выполнить следующую команду с изменённым конфигурационным файлом:

```bash
ydb -e grpc://<node.ydb.tech>:2135 cluster config replace -f config.yaml
```

В результате проделанных действий кластер будет переведён в режим автоматического управление конфигурацией [State Storage](../../../../reference/configuration/index.md#domains-state) и [статической группой](../../../../reference/configuration/index.md#blob_storage_config). Технически, оно осуществляется с помощью механизма [распределённой конфигурации](../../../../concepts/glossary.md#distributed-configuration).
