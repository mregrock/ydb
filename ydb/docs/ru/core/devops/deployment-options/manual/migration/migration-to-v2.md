# Миграция на конфигурацию v2

Данный документ содержит инструкцию по миграции с [конфигурации v1](../before-v25.1/configuration-management/config-overview.md) на [конфигурацию v2](../../../configuration-management/index.md).

## Исходное состояние

Миграция на конфигурацию v2 может быть осуществлена в случае выполнения следующих условий:

1. Кластер {{ydb-short-name}} [обновлен](../../../maintenance/upgrade.md) до версии 25.1 и выше.
1. Кластер {{ydb-short-name}} сконфигурирован с файлом [конфигурации v1](../before-v25.1/configuration-management/config-overview.md#static-config) `config.yaml`, расположенным на файловой системе узлов и подключенным через аргумент `ydbd --yaml-config`.

Убедиться, что на кластере отсутствует конфигурация v2 можно проверив аргументы запуска узлов кластера:

```bash
ps aux | grep ydbd
```

Если на кластере присутствует конфигурация v2, то в выводе команды будет присутствовать опция `ydbd --config-store`.

Продолжать двигаться по данной инструкции необходимо только в случае отсутствия опции `ydbd --config-store` в выводе команды.

## Переход на конфигурацию v2

Для того чтобы перевести кластер {{ ydb-short-name }} на механизм конфигурации v2, необходимо проделать следующие шаги:

1. Проверить наличие файла [динамической конфигурации](../before-v25.1/configuration-management/config-overview.md#dynamic-config) на кластере. Для этого необходимо выполнить команду:

    ```bash
    ydb -e grpc://<node.ydb.tech>:2135 admin cluster config fetch > config.yaml
    ```

    В случае отсутствия такой конфигурации на кластере, команда выдаст сообщение:

    ```bash
    YAML config is absent on this cluster.
    ```

1. (В случае отсутствия файла динамической конфигурации на кластере) Выполнить команду генерации файла динамической конфигурации. Файл будет сгенерирован на основе файла статической конфигурации, лежащего на узлах кластера:

    ```bash
    ydb -e grpc://<node.ydb.tech>:2135 admin cluster config generate > config.yaml
    ```

1. Скопировать полученный файл `config.yaml` на все узлы кластера, заместив им предыдущий файл конфигурации.
1. Создать директорию для работы кластера с конфигурацией на каждом из узлов. В случае поднятия нескольких узлов на одной машине, используйте одну и ту же директорию. Инициализируйте директорию, выполнив команду на каждом из узлов:

    ```bash
    mkdir -p /opt/ydb/config-store
    ydb admin cluster config init --config-store /opt/ydb/config-store --from-file /opt/ydb/cfg/config.yaml
    ```

    В дальнейшнем система самостоятельно будет сохранять конфигурацию в указанную директорию.

4. Перезапустить все узлы кластера с помощью процедуры [rolling-restart](../../../../maintenance/manual/node_restarting.md), добавив опцию `ydbd --config-store` при запуске узла с указанием пути до директории.

1. Выполнить следующую команду с конфигурационным файлом:

    ```bash
    ydb -e grpc://<node.ydb.tech>:2135 cluster config replace -f config.yaml
    ```

    Команда запросит подтверждение на выполнение операции, в ответ на запрос необходимо ввести `y`.

    После выполнения команды, конфигурационный файл будет загружен на кластер и сохранён на всех узлах в директории, указанной в опции `ydbd --config-store`.


В результате проделанных действий конфигурация кластера будет переведена на механизм конфигурации v2. Любое изменение конфигурации на существующих узлах выполняется с помощью [команд YDB CLI](../update-config.md). при первоначальном запуске узла, как и прежде, конфигурация будет загружаться из файла, указанного в опции `ydbd --yaml-config`. Однако при повторном запуске узла, актуальная конфигурация будет загружена из директории, указанной в опции `ydbd --config-store`.
